---
import config from "virtual:starlight/user-config";
import DefaultFooter from '@astrojs/starlight/components/Footer.astro';
import esf from '../assets/EFRE-ESF_LO_Kombination_EU-Logo_SachsenSignet-klassisch_H_RGB.png';
import schlaumeiseLogo from '../assets/favicon.svg';
import schlaumeiseMark from '../assets/SchlaumeiseLogo.svg';
import smartfinchMark from '../assets/SmartfinchLogo.svg';
import '../styles/global.css';

const year = new Date().getFullYear();
const base = import.meta.env.BASE_URL;
let hasStarlightContext = false;
try {
  hasStarlightContext = Boolean((Astro as any).locals?.starlightRoute);
} catch {
  hasStarlightContext = false;
}

const activeLocale = (() => {
  try {
    return (Astro as any).locals?.starlightRoute?.locale;
  } catch {
    return undefined;
  }
})();
const defaultLocale = config.defaultLocale?.locale ?? "root";
const resolvedLocale = activeLocale ?? defaultLocale;
const localeSlug = resolvedLocale && resolvedLocale !== "root" ? resolvedLocale : "";
const isEnglish = resolvedLocale === "en";
const brandName = isEnglish ? "Smartfinch" : "Schlaumeise";
const brandMark = isEnglish ? smartfinchMark : schlaumeiseMark;
const brandAria = isEnglish ? "Smartfinch home" : "Schlaumeise Startseite";
const imprintLabel = isEnglish ? "Imprint" : "Impressum";
const ensureSlash = (value: string) => (value.endsWith("/") ? value : `${value}/`);
const buildHref = (slug = "") => {
  const cleanedSlug = slug.replace(/^\/+|\/+$/g, "");
  const relative = [localeSlug, cleanedSlug].filter(Boolean).join("/");
  const url = new URL(relative || ".", new URL(base, "http://example.com"));
  return ensureSlash(url.pathname);
};
const homeHref = buildHref();
const imprintHref = buildHref("impressum");
---

{hasStarlightContext && <DefaultFooter />}

<footer class="site-footer" aria-labelledby="site-footer-heading">
  <h2 id="site-footer-heading" class="sr-only">Website footer</h2>

  <div class="footer-content">
    <div class="brand-block">
      <a class="brand" href={homeHref} aria-label={brandAria}>
        <img
          src={(brandMark?.src ?? schlaumeiseLogo.src)}
          alt={`${brandName} Logo`}
          width="40"
          height="40"
          loading="lazy"
          decoding="async"
        />
        <span class="brand-name">{brandName}</span>
      </a>

    </div>

    <nav class="footer-links" aria-label="Footer links">
      <a href={imprintHref}>{imprintLabel}</a>
      <a href="https://github.com/rajsei/schlaumeise">GitHub</a>
    </nav>

    <div class="funding-block">
      <img
        class="funding-logo"
        src={esf.src}
        alt="Gefördert durch die Europäische Union (EFRE) und den Freistaat Sachsen"
        loading="lazy"
        decoding="async"
      />
    </div>
  </div>

  <div class="footer-meta">
    <p> · &copy; {year} {brandName} · </p>
  </div>
</footer>

<style>
  @layer starlight.components {
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 1px, 1px);
      white-space: nowrap;
      border: 0;
    }

    .site-footer {
      background-color: var(--sl-color-gray-6); /* match navbar in light/dark */
      margin-top: 0.5rem;
      padding: 1.25rem 1.5rem;
      border-top: 1px solid color-mix(in srgb, var(--sl-color-gray-5), transparent 30%);
      font-size: var(--sl-text-sm);
    }

    .footer-content {
      display: grid;
      gap: 1rem 1rem;
      align-items: center;
      justify-content: center; /* mobile portrait: stack centered */
      grid-template-columns: 1fr; /* single column */
    }

    .brand-block {
      display: flex;
      flex-direction: column;
      align-items: center; /* center on mobile */
      gap: 0.75rem;
    }

    .brand {
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
      color: var(--sl-color-text);
      text-decoration: none;
    }
    .brand:hover .brand-name { text-decoration: underline; }
    .brand-name { font-weight: 600; }

    .footer-links {
      display: grid;
      grid-template-columns: 1fr; /* mobile: single column */
      gap: 0.4rem 1rem;
      justify-items: center;
      text-align: center;
    }
    .footer-links a {
      color: var(--sl-color-gray-3);
      text-decoration: none;
      display: block;
    }
    .footer-links a:hover { color: var(--sl-color-white); }

    .funding-block {
      display: flex;
      align-items: center;
      justify-content: center; /* centered on small screens */
    }
    .funding-logo {
      max-width: min(400px, 100%);
      height: auto;
      border-radius: 2px;
      background: #eceff4; /* ensure logo readable in dark mode */
      padding: 0.25rem 0.5rem;
    }

    .footer-meta {
      margin-top: 0.75rem;
      text-align: center;
      color: var(--sl-color-gray-3);
    }

    @media (min-width: 48rem) {
      .footer-content {
        grid-template-columns: 1fr auto 1fr; /* equal sides | centered links */
      }
      .brand-block {
        flex-direction: column;
        align-items: flex-start; /* logo left */
        justify-self: start;
        margin-left: 5%; /* margin from left edge on wide screens */
      }
      .footer-links {
        margin-left: 0;
        justify-self: center; /* true page center */
        width: max-content; /* shrink to content so centering is visible */
      }
      .funding-block {
        justify-content: flex-end;
        justify-self: end; /* logo to the right edge */
        margin-right: 5%; /* margin from right edge on wide screens */
      }
      .footer-meta { margin-top: 1rem; }
    }

    @media (min-width: 64rem) {
      .footer-links {
        grid-template-columns: repeat(2, minmax(140px, auto));
        gap: 0.6rem 1.5rem; /* 2 columns */
      }
      .funding-logo { max-width: min(340px, 100%); }
    }
  }
</style>
