---
import config from "virtual:starlight/user-config";
import SocialIcons from "@astrojs/starlight/components/SocialIcons.astro";
import ThemeSelect from "@astrojs/starlight/components/ThemeSelect.astro";
import schlaumeiseIcon from "../assets/SchlaumeiseLogo.svg";
import smartfinchIcon from "../assets/SmartfinchLogo.svg";

interface Props {
  currentPath?: string;
  enableStarlightControls?: boolean;
}

let LanguageSelect: any = null;

const { currentPath, enableStarlightControls = true } = Astro.props as Props;
const base = import.meta.env.BASE_URL;
const astroPath = Astro && Astro.url && Astro.url.pathname ? Astro.url.pathname : "/";
const pathname = currentPath ?? astroPath ?? "/";
const hasStarlightRoute = (() => {
  try {
    return Boolean((Astro as any).locals?.starlightRoute);
  } catch {
    return false;
  }
})();
const hasTranslations = (() => {
  try {
    return Boolean((Astro as any).locals?.t);
  } catch {
    return false;
  }
})();
if (enableStarlightControls && hasStarlightRoute) {
  const { default: LanguageSelectComponent } = await import(
    "@astrojs/starlight/components/LanguageSelect.astro"
  );
  LanguageSelect = LanguageSelectComponent;
}
const allowLanguageSelect = enableStarlightControls && hasStarlightRoute && LanguageSelect;

const selectedLocale = (() => {
  try {
    return (Astro as any).locals?.starlightRoute?.locale;
  } catch {
    return undefined;
  }
})();
const defaultLocale = config.defaultLocale?.locale ?? "root";
const activeLocale = selectedLocale ?? defaultLocale;
const localeSlug = activeLocale && activeLocale !== "root" ? activeLocale : "";
const basePath = base.replace(/\/+$/, "") || "/";
const isEnglish = activeLocale === "en";
const brandName = isEnglish ? "Smartfinch" : "Schlaumeise";
const brandIcon = isEnglish ? smartfinchIcon : schlaumeiseIcon;
const homeLabel = isEnglish ? "Go to homepage" : "Zur Startseite";
const navAriaLabel = isEnglish ? "Main navigation" : "Hauptnavigation";
const menuLabel = isEnglish ? "Open menu" : "Menue oeffnen";
const barsPath = "M3 8h18a1 1 0 1 0 0-2H3a1 1 0 0 0 0 2Zm18 8H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2Zm0-5H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2Z";

const ensureTrailingSlash = (value: string) => (value.endsWith("/") ? value : `${value}/`);
const buildHref = (slug = "") => {
  const cleanedSlug = slug.replace(/^\/+|\/+$/g, "");
  const relativePath = [localeSlug, cleanedSlug].filter(Boolean).join("/");
  const url = new URL(relativePath || ".", new URL(base, "http://example.com"));
  return ensureTrailingSlash(url.pathname);
};

const normalizePath = (value: string) => {
  const safe = value.startsWith("http")
    ? new URL(value).pathname
    : value.startsWith(base)
      ? value
      : `${basePath}/${value.replace(/^\//, "")}`;
  const cleaned = safe.replace(base, "/").replace(/\/+/g, "/") || "/";
  if (cleaned === "/") return cleaned;
  return cleaned.endsWith("/") ? cleaned : `${cleaned}/`;
};

const current = normalizePath(pathname);
const homeHref = buildHref();

const navLabels = isEnglish
  ? {
      start: "Home",
      projects: "Projects",
      knowledge: "Knowledge Base",
      quiz: "Quiz",
      imprint: "Imprint",
    }
  : {
      start: "Start",
      projects: "Projekte",
      knowledge: "Wissenssammlung",
      quiz: "Quiz",
      imprint: "Impressum",
    };

const navItems = [
  { label: navLabels.start, slug: "" },
  { label: navLabels.projects, slug: "projects" },
  { label: navLabels.knowledge, slug: "knowledge_collection/biology" },
  { label: navLabels.quiz, slug: "quiz" },
  { label: navLabels.imprint, slug: "impressum" },
];

const itemsWithState = navItems.map((item) => {
  const href = buildHref(item.slug);
  const path = normalizePath(href);
  const isActive = item.slug === "" ? current === path : current.startsWith(path);
  return { ...item, href, path, isActive };
});
---

<div class="global-header__inner">
  <div class="global-header__brand">
    <a class="global-header__logo" href={homeHref} aria-label={homeLabel}>
      <img src={brandIcon.src} alt="" width="32" height="32" loading="lazy" decoding="async" />
      <span class="global-header__title">{brandName}</span>
    </a>
  </div>

  <nav id="site-navigation" class="global-nav" aria-label={navAriaLabel} data-nav data-open="false">
    <ul class="global-nav__list">
      {itemsWithState.map((item) => (
        <li>
          <a
            href={item.href}
            class={["global-nav__link", item.isActive && "is-active"].filter(Boolean).join(" ")}
            aria-current={item.isActive ? "page" : undefined}
          >
            {item.label}
          </a>
        </li>
      ))}
    </ul>
  </nav>

  <div class="global-header__controls">
    <div class="global-header__actions">
    {(hasTranslations || allowLanguageSelect) && (
      <div class="global-header__shortcuts">
        {hasTranslations && (
          <>
              <SocialIcons />
              <ThemeSelect />
            </>
          )}
          {allowLanguageSelect && <LanguageSelect />}
        </div>
      )}
    </div>
    <button
      class="global-header__toggle"
      type="button"
      aria-expanded="false"
      aria-label={menuLabel}
      aria-controls="site-navigation"
      data-nav-toggle
    >
      <svg
        class="global-header__toggle-icon"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        role="img"
        aria-hidden="true"
        focusable="false"
      >
        <path d={barsPath} fill="currentColor"></path>
      </svg>
    </button>
  </div>
</div>

<script type="module">
  const script = document.currentScript;
  const header = script ? script.closest(".global-header") : null;
  const toggle = header ? header.querySelector("[data-nav-toggle]") : null;
  const nav = header ? header.querySelector("[data-nav]") : null;

  if (toggle instanceof HTMLButtonElement && nav instanceof HTMLElement) {
    const closeOnEscape = (event) => {
      if (event.key === "Escape") {
        toggle.setAttribute("aria-expanded", "false");
        nav.dataset.open = "false";
      }
    };

    toggle.addEventListener("click", () => {
      const isOpen = toggle.getAttribute("aria-expanded") === "true";
      toggle.setAttribute("aria-expanded", String(!isOpen));
      nav.dataset.open = String(!isOpen);
      if (!isOpen) {
        document.addEventListener("keydown", closeOnEscape, { once: true });
      }
    });
  }
</script>

<style>
  @layer starlight.components {
  .global-header__inner {
    max-width: 100rem;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: nowrap;
  }

  .global-header__brand {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    min-width: 0;
    flex: 0 0 auto;
  }

  .global-header__logo {
    display: inline-flex;
    align-items: center;
    gap: 0.6rem;
    color: var(--sl-color-white);
    font-weight: 700;
    text-decoration: none;
    letter-spacing: -0.01em;
  }

  .global-header__logo img {
    border-radius: 999px;
    box-shadow: 0 0 12px rgb(0 0 0 / 0.25);
  }

  .global-header__title {
    font-size: 1.1rem;
  }

  .global-header__controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-inline-start: auto;
    flex-shrink: 0;
    flex-wrap: nowrap;
  }

  .global-header__actions {
    display: flex;
    align-items: center;
    gap: 0.65rem;
    min-width: 0;
  }

  .global-header__shortcuts {
    display: flex;
    gap: 0.4rem;
    align-items: center;
  }

  .global-header__toggle {
    display: none;
    border: 1px solid color-mix(in srgb, var(--sl-color-gray-3), transparent 45%);
    border-radius: 999px;
    padding: 0.45rem;
    color: var(--sl-color-white);
    background: transparent;
    width: 2.5rem;
    height: 2.5rem;
    align-items: center;
    justify-content: center;
  }

  .global-header__toggle:focus-visible {
    outline: 2px solid var(--sl-color-accent);
    outline-offset: 2px;
  }

  .global-header__toggle-icon {
    font-size: 1.25rem;
    color: currentColor;
  }

  .global-nav {
    flex: 1;
    min-width: 0;
  }

  .global-nav__list {
    list-style: none;
    display: flex;
    gap: 0.7rem;
    margin: 0;
    padding: 0;
    justify-content: center;
    flex-wrap: wrap;
  }

  .global-nav__link {
    color: var(--sl-color-gray-1);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.95rem;
    padding: 0.38rem 0.8rem;
    border-radius: 999px;
    transition:
      color 150ms ease,
      background 150ms ease;
  }

  .global-nav__link:hover,
  .global-nav__link:focus-visible {
    color: var(--sl-color-white);
    background: color-mix(in srgb, var(--sl-color-accent), transparent 70%);
  }

  .global-nav__link.is-active {
    color: var(--sl-color-white);
    background: var(--sl-color-accent-low);
  }

  @media (max-width: 72rem) {
    .global-header__title {
      display: none;
    }
  }

  @media (max-width: 64rem) {
    .global-header__inner {
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .global-header__brand {
      order: 1;
      flex: 0 0 auto;
      width: auto;
      justify-content: flex-start;
    }

    .global-header__toggle {
      display: none;
    }

    .global-nav {
      order: 2;
      flex: 1 1 auto;
      width: auto;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0;
      flex-wrap: wrap;
    }

    .global-nav__list {
      flex-direction: row;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0;
      gap: 0.45rem;
      flex-wrap: wrap;
    }

    .global-header__controls {
      order: 3;
      width: 100%;
      justify-content: flex-end;
      flex-wrap: nowrap;
      gap: 0.3rem;
      align-self: flex-start;
    }

    .global-header__actions {
      order: 0;
      flex: 0 0 auto;
      margin-inline-start: auto;
      justify-content: flex-end;
      flex-wrap: nowrap;
      gap: 0.3rem;
      padding: 0.18rem 0.4rem;
      /* background: var(--sl-color-gray-6); */
      border-radius: 0.65rem;
      align-self: flex-start;
      box-sizing: border-box;
      text-align: right;
      font-size: 0.9rem;
    }
  }

  @media (max-width: 50rem) {
    .global-nav__list > li:first-child {
      display: none;
    }

    .global-nav__list {
      gap: 0.35rem;
    }

    .global-header__actions {
      padding: 0.14rem 0.35rem;
      gap: 0.22rem;
    }
  }
}
</style>
